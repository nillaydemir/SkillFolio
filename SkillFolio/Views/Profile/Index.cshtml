@model SkillFolio.Models.ApplicationUser
@using Microsoft.AspNetCore.Identity
@using SkillFolio.Data
@using SkillFolio.ViewModels
@inject UserManager<ApplicationUser> UserManager
@inject SkillFolioDbContext Context

@{
    ViewData["Title"] = "Profilim ve Yönetim Paneli";

    bool isAdmin = User.IsInRole("Admin");

    //  SADECE ProfileController’dan gelen takvim
    var calendar = ViewBag.Calendar as CalendarViewModel;

    string profileImagePath = Model.ProfileImagePath ?? "/images/default/avatar.png";
}

<h1 class="display-5 text-primary">
    Merhaba, @Model.FirstName @Model.LastName @(isAdmin ? "(YÖNETİCİ)" : "")
</h1>
<hr />

<div class="row pt-3">

    @if (isAdmin)
    {
        <div class="col-md-12">
            <div class="card p-5 shadow-lg border-danger">
                <h3 class="text-danger mb-4">🛠 Yönetici Kontrol Merkezi</h3>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card card-body bg-light border-dark">
                            <h5>Etkinlik Yönetimi</h5>
                            <p class="small text-muted">Tüm etkinlikleri yönetin.</p>
                            <a asp-controller="Events" asp-action="Index" class="btn btn-dark btn-sm">Tüm Etkinlikler</a>
                            <a asp-controller="Events" asp-action="Create" class="btn btn-outline-dark btn-sm mt-2">Yeni Ekle</a>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card card-body bg-light border-dark">
                            <h5>Kullanıcı Denetimi</h5>
                            <p class="small text-muted">Roller ve kullanıcılar.</p>
                            <button class="btn btn-secondary btn-sm" disabled>Kullanıcı Listesi (-)</button>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card card-body bg-light border-dark">
                            <h5>Sistem İstatistikleri</h5>
                            <ul class="list-unstyled small">
                                <li>Toplam Etkinlik: @Context.Events.Count()</li>
                                <li>Toplam Kullanıcı: @UserManager.Users.Count()</li>
                                <li>Toplam Sertifika: @Context.Certificates.Count()</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="col-md-5">

            <!-- PROFİL -->
            <div class="card shadow p-4 mb-4 border-0">
                <div class="text-center mb-3">
                    <img src="@profileImagePath"
                         class="img-thumbnail"
                         style="width:150px;height:150px;object-fit:cover;border-radius:50%;" />
                </div>

                <h5 class="fw-bold">Personal Information</h5>
                <hr />

                <dl class="row small">
                    <dt class="col-sm-5">Ad Soyad:</dt>
                    <dd class="col-sm-7">@Model.FirstName @Model.LastName</dd>

                    <dt class="col-sm-5">Okul/Bölüm:</dt>
                    <dd class="col-sm-7">@Model.SchoolName / @Model.Department</dd>

                    <dt class="col-sm-5">Eğitim Yılları:</dt>
                    <dd class="col-sm-7">@Model.StartYear - @(Model.EndYear ?? DateTime.Now.Year)</dd>

                    <dt class="col-sm-5">Doğum Tarihi:</dt>
                    <dd class="col-sm-7">@Model.BirthDate.ToShortDateString()</dd>
                </dl>

                <a asp-controller="Profile" asp-action="Edit"
                   class="btn btn-outline-secondary btn-sm mt-2">
                    Profili Düzenle
                </a>
            </div>

            <!-- DUYURU -->
            <div class="card shadow p-4 mb-4 border-0">
                <h5 class="fw-bold text-info">📢 Duyuru Gruplarım</h5>
                <p class="small text-muted">Okul ve bölüm duyuruları.</p>
                <a asp-controller="Announcements" asp-action="Groups"
                   class="btn btn-info btn-sm w-100">
                    Duyuru Gruplarım
                </a>
            </div>

            <!-- 🔥 PROFİL TAKVİMİ -->
            <div class="card shadow p-4 mb-4 border-0">
                <h5 class="fw-bold text-primary">📅 Etkinlik Takvimim</h5>

                @if (calendar != null && calendar.EventsByDay.Any())
                {
                    @await Html.PartialAsync("_Calendar", calendar)
                }
                else
                {
                    <p class="text-muted small mb-0">
                        Bu ay için favorilediğiniz veya kayıt olduğunuz etkinlik bulunmuyor.
                    </p>
                }
            </div>
        </div>

        <!-- SAĞ TARAF -->
        <div class="col-md-7">

            <!-- SERTİFİKALAR -->
            <div class="card p-4 shadow-sm border-success mb-4">
                <h5 class="text-success">
                    ✅ Sertifikalı / Katılım Onaylı Etkinlikler (@(Model.Certificates?.Count ?? 0))
                </h5>
                <hr />

                @if (Model.Certificates?.Any() == true)
                {
                    <div class="row">
                        @foreach (var cert in Model.Certificates)
                        {
                            <div class="col-6 mb-3">
                                <div class="card bg-light p-2 h-100 border-success">
                                    <strong>@cert.Event?.Title</strong>
                                    <small class="text-muted">@cert.Title</small>
                                    <a asp-controller="Events"
                                       asp-action="Details"
                                       asp-route-id="@cert.EventId"
                                       class="btn btn-outline-success btn-sm mt-2">
                                        Detay / Yorum
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-info small">
                        Henüz onaylı etkinliğiniz yok.
                    </div>
                }
            </div>

            <!-- FAVORİLER -->
            <div class="card p-4 shadow-sm border-danger mb-4">
                <h5 class="text-danger">
                    ❤️ Favorilenen Etkinlikler (@(Model.Favorites?.Count ?? 0))
                </h5>
                <hr />

                @if (Model.Favorites?.Any() == true)
                {
                    <div class="row">
                        @foreach (var fav in Model.Favorites)
                        {
                            <div class="col-6 mb-3">
                                <div class="card bg-light p-2 h-100 border-danger">
                                    <strong>@fav.Event?.Title</strong>
                                    <small class="text-muted">
                                        Favorileme: @fav.DateFavorited.ToShortDateString()
                                    </small>
                                    <a asp-controller="Events"
                                       asp-action="Details"
                                       asp-route-id="@fav.EventId"
                                       class="btn btn-outline-danger btn-sm mt-2">
                                        Detay Gör
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-info small">Favori listeniz boş.</div>
                }
            </div>

            <div class="card p-4 shadow-sm border-0">
                <h5 class="text-secondary">Önerilen Eğitimler</h5>
                <p class="text-muted small">
                    Profil bilgilerinize göre önerilecektir.
                </p>
            </div>
        </div>
    }
</div>
