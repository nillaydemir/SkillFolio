@model SkillFolio.Models.ApplicationUser
@using System.Text.Json
@using System.Linq
@using Microsoft.AspNetCore.Identity;
@using SkillFolio.Data;
@inject UserManager<ApplicationUser> UserManager
@inject SkillFolioDbContext Context

@{
    ViewData["Title"] = "Profilim ve Yönetim Paneli";

    // --- Kontroller ---
    bool isAdmin = User.IsInRole("Admin");

    // Yalnızca standart kullanıcı için gerekli veriler:
    var calendarEvents = ViewBag.CalendarEvents as List<dynamic> ?? new List<dynamic>();
    var jsonEvents = Json.Serialize(calendarEvents);

    // Profil fotoğrafı yolu: Yoksa varsayılan avatar gösterilir.
    string profileImagePath = Model.ProfileImagePath ?? "/images/default/avatar.png";
}

<h1 class="display-5 text-primary">Merhaba, @Model.FirstName @Model.LastName @(isAdmin ? "(YÖNETİCİ)" : "")</h1>
<hr />

<div class="row pt-3">

    @if (isAdmin)
    {
        <div class="col-md-12">
            <div class="card p-5 shadow-lg border-danger">
                <h3 class="text-danger mb-4"><i class="fas fa-tools"></i> Yönetici Kontrol Merkezi</h3>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card card-body bg-light border-dark">
                            <h5 class="text-dark">Etkinlik Yönetimi</h5>
                            <p class="small text-muted">Sitedeki tüm etkinlikleri yönetin.</p>
                            <a asp-controller="Events" asp-action="Index" class="btn btn-sm btn-dark mt-auto">Tüm Etkinlikler</a>
                            <a asp-controller="Events" asp-action="Create" class="btn btn-sm btn-outline-dark mt-2">Yeni Ekle</a>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card card-body bg-light border-dark">
                            <h5 class="text-dark">Kullanıcı Denetimi</h5>
                            <p class="small text-muted">Sisteme kayıtlı kullanıcıları ve rolleri denetleyin.</p>
                            <a asp-controller="Events" asp-action="Index" class="btn btn-sm btn-dark mt-auto disabled">Kullanıcı Listesi (Eksik)</a>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card card-body bg-light border-dark">
                            <h5 class="text-dark">Sistem İstatistikleri</h5>
                            <p class="small text-muted">Yüklenen sertifika ve yapılan yorum sayısı.</p>
                            <ul class="list-unstyled small">
                                <li>Toplam Etkinlik: @Context.Events.Count()</li>
                                <li>Toplam Kullanıcı: @UserManager.Users.Count()</li>
                                <li>Toplam Sertifika: @Context.Certificates.Count()</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="col-md-5">

            <div class="card profile-card shadow p-4 mb-4 border-0">

                <div class="text-center mb-4">
                    <img src="@profileImagePath" alt="Profil Fotoğrafı" class="img-thumbnail"
                         style="width: 150px; height: 150px; object-fit: cover; border-radius: 50%; border: 3px solid #007bff;" />
                </div>

                <h5 class="fw-bold">Personal Information <i class="fas fa-user-circle"></i></h5>
                <hr class="my-2" />

                <dl class="row mt-3 small">
                    <dt class="col-sm-5">Ad Soyad:</dt>
                    <dd class="col-sm-7">@Model.FirstName @Model.LastName</dd>

                    <dt class="col-sm-5">Okul/Bölüm:</dt>
                    <dd class="col-sm-7">@Model.SchoolName / @Model.Department</dd>

                    <dt class="col-sm-5">Eğitim Yılları:</dt>
                    <dd class="col-sm-7">@Model.StartYear - @(Model.EndYear.HasValue? Model.EndYear.ToString() : "Devam")</dd>

                    <dt class="col-sm-5">Doğum Tarihi:</dt>
                    <dd class="col-sm-7">@Model.BirthDate.ToShortDateString()</dd>
                </dl>

                <a asp-controller="Profile" asp-action="Edit" class="btn btn-sm btn-outline-secondary mt-2">Profili Düzenle</a>
            </div>

            <div class="card profile-card shadow p-4 mb-4 border-0">

                <h5 class="fw-bold mb-3 text-primary">
                    📅 Etkinlik Takvimim
                </h5>

                @if (calendarEvents.Any())
                {
                    @await Html.PartialAsync(
                        "_Calendar",
                        new SkillFolio.ViewModels.CalendarViewModel
                        {
                            Year = DateTime.Now.Year,
                            Month = DateTime.Now.Month,
                            EventsByDay = calendarEvents
                                .GroupBy(e => ((DateTime)e.Date).Day)
                                .ToDictionary(
                                    g => g.Key,
                                    g => g.Select(x => (string)x.Title).ToList()
                                )
                        }
                    )
                }
                else
                {
                    <p class="text-muted small mb-0">
                        Bu ay için kayıtlı olduğunuz etkinlik bulunmuyor.
                    </p>
                }
            </div>
        </div>

        <div class="col-md-7">

            <div class="card p-4 shadow-sm border-success mb-4">
                <h5 class="text-success">✅ Sertifikalı/Katılım Onaylı Etkinlikler (@(Model.Certificates?.Count ?? 0))</h5>
                <hr />
                <div class="row">
                    @if (Model.Certificates != null && Model.Certificates.Any())
                    {
                        @foreach (var cert in Model.Certificates)
                        {
                            <div class="col-6 mb-3">
                                <div class="card bg-light border-success h-100 p-2">
                                    <strong class="text-truncate">@cert.Event?.Title</strong>
                                    <small class="text-muted">Sertifika: @cert.Title</small>
                                    <a asp-controller="Events" asp-action="Details" asp-route-id="@cert.EventId" class="btn btn-sm btn-outline-success mt-2">Detay/Yorum Yap</a>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info small">Henüz katılım onayı eklenmiş etkinliğiniz yok.</div>
                    }
                </div>
            </div>

            <div class="card p-4 shadow-sm border-danger mb-4">
                <h5 class="text-danger">❤️ Favorilenen Etkinlikler (@(Model.Favorites?.Count ?? 0))</h5>
                <hr />
                <div class="row">
                    @if (Model.Favorites != null && Model.Favorites.Any())
                    {
                        @foreach (var fav in Model.Favorites)
                        {
                            <div class="col-6 mb-3">
                                <div class="card bg-light border-danger h-100 p-2">
                                    <strong class="text-truncate">@fav.Event?.Title</strong>
                                    <small class="text-muted">Favorileme Tarihi: @fav.DateFavorited.ToShortDateString()</small>
                                    <a asp-controller="Events" asp-action="Details" asp-route-id="@fav.EventId" class="btn btn-sm btn-outline-danger mt-2">Detay Gör</a>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info small">Favori listeniz boş.</div>
                    }
                </div>
            </div>

            <div class="card p-4 shadow-sm border-0 profile-card">
                <h5 class="text-secondary">Önerilen Eğitimler (Recommended Trainings)</h5>
                <p class="text-muted">Profil bilgilerine (Bölüm, Okul) göre sistemin önerdiği etkinlikler burada listelenecektir.</p>
            </div>
        </div>
    }
</div>

